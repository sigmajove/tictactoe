<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tic Tac Toe</title>
</head>
<script>

const squareButton = `<button onclick="clickSquare(this.parentElement.id)"
style="display:block; background: transparent; border: none !important;
font-size:0; height:50px; width:50px;">
</button>`

const xSquare = `<svg width="50" height="50">
<path d="M 5 5 L 45 45 M 45 5 L 5 45"
style="stroke:blue;stroke-width:4" />
</svg>`

const oSquare = `<svg style="width="50" height="50">
<ellipse cx="25" cy="25", rx="20", ry="20"
style="fill:none;stroke:blue;stroke-width:4" />
</svg>`

const restartHTML = `<button onclick="restartButton()">Play Again</button>`;

// Representation of the board. Values are "X", "O", and " ".
// Redundant with objects in the Dom.
let board = null;
let gameOver = null;

// Which players are which. The values are "X" or "O".
let myXO = null;
let computerX0 = null;

function playButton() {
    switch (document.querySelector("input[name=who]:checked").value) {
        case "first":
            myXO = "X";
            computerXO = "O";
            break;
        case "second":
            myXO = "O";
            computerXO = "X";
            break;
    }

    gameOver = false;
    board = Array.from(" ".repeat(9));
    if (myXO == "O") {
        board[Math.floor(Math.random() * 9)] = "X";
    }
    document.getElementById("message").innerHTML =
        "<p>Click on a square to make a move</p>";

    document.getElementById("selector").style.display = "none";
    document.getElementById("board").style.display = "grid";
    document.getElementById("message").style.display = "block";


    for (let i = 0; i < 9; i++) {
        document.getElementById(`square${i}`).innerHTML =
            board[i] == " " ? squareButton : xSquare;
    }
}

function restartButton() {
    document.getElementById("selector").style.display = "block";
    document.getElementById("board").style.display = "none";
    document.getElementById("message").style.display = "none";
}

// Rotates a board 90 degrees counterclockwise.
function rotate(b) {
    return `${b[2]}${b[5]}${b[8]}${b[1]}${b[4]}${b[7]}${b[0]}${b[3]}${b[6]}`;

}
// Returns the mirror image of a board.
function mirror(b) {
    return `${b[2]}${b[1]}${b[0]}${b[5]}${b[4]}${b[3]}${b[8]}${b[7]}${b[6]}`;
}

// Calls func on the eight symmetric variations on board.
function symmetry(func, board) {
    let b = board;
    func(b);
    b = rotate(b);
    func(b);
    b = rotate(b);
    func(b);
    b = rotate(b);
    func(b);
    b = mirror(b);
    func(b);
    b = rotate(b);
    func(b);
    b = rotate(b);
    func(b);
    b = rotate(b);
    func(b);
}

let goodMoves = new Map();

function addToMap(board) {
    let moves = [];
    let boardArr = board.split("");

    for (let i = 0; i < boardArr.length; i++) {
        if (boardArr[i] == "$") {
            moves.push(i);
            boardArr[i] = " ";
        }
    }
    goodMoves.set(boardArr.join(""), moves);
}               

// Strategy table.
// Each string represents the nine squares 012345678
// Each $ represents an acceptable response.
// Each entry represents eight reflections and rotations.
// If a board position is not listed,  then it doesn't matter.
const patterns = [
"X   $    ", "XO $$ $  ", "XOX $    ", "XOXO$   $", "XOXO$  X$", "XOXO  OX$",
"XOX   O $", "XOXX  O$ ", "XOX $$OX$", "XO X$ O  ", "XO X$$OX$", "XO $X $ O",
"XO  $X   ", "XOO$$X$$ ", "XOOO X X$", "XOO$ X XO", "XO O X  $", "XO O X X$",
"XO OOX X$", "XO  OX$X$", "XO  $XO $", "XO  $XOX$", "XO $ X  O", "XO $$X$XO",
"XO    $X$", "XOO$ $$X$", "XO  O $X ", "XO   O$X$", "X O$  $ $", "XXO  $  $",
"XXO   $O$", "XXO  X$O ", "XXO  X$ O", "X O$$X   ", "X O$$X O ", "X O$ X  O",
"X O$$X XO", "X O    X$", "X$$ OX $$", "X$$ OX$$O", "X$ $O$ $X", "X $ $O$  ",
"X   $O X ", "X $   $ O", "X $ X $ O", "X  $$X$ O", "$X$ $  $ ", "OX $$ $ $",
"OX X$$ $ ", "OXOX$    ", "OX$X$O $$", "OX $X$$O$", "OX   X$  ", "OX $$X$O$",
"$X O$    ", "$X$OX  O ", " X OXX$O ", " X$O X  $", " X$OOX   ", "$X OOX$X ",
" X$O X O ", "$X$$O$$ $", "$X$XO $  ", "$X    O  ", "$X   XO $", "$X$ X $O$",
"$ $ X $ $", "$O$$X$$ $"];
for (let i = 0; i < patterns.length; i++) {
    symmetry((b) => {addToMap(b);}, patterns[i]);
}

function checkRows(func) {
    // Calls func on horizontal, vertical, and diagonal rows.
    func(0, 1, 2);
    func(3, 4, 5);
    func(6, 7, 8);
    func(0, 3, 6);
    func(1, 4, 7);
    func(2, 5, 8);
    func(0, 4, 8);
    func(2, 4, 6);
}

// Returns true if the game is over.
function checkGameOver(who) {
    let winner = false;
    checkRows((x, y, z) => {
        let bx = board[x];
        let by = board[y];
        let bz = board[z];
        if (bx == by && by == bz && bx != " ") {
            winner = true;
        }});
    if (winner) {
        document.getElementById("message").innerHTML =
                    `<h3>${who} wins ${restartHTML}</h3>`;
        return true;
    }
    for (let i = 0; i < 9; i++) {
        if (board[i] == " ") {
            return false;
        }
    }
    // The game ended in a draw.
    document.getElementById("message").innerHTML =
                `<h3>Tie game ${restartHTML}</h3>`;
    return true;
}

function checkTwoInARow(who) {
    // If a row contains two whos in a row and a space, return
    // the index of the space. Return every such index.
    let moves = []
    checkRows((x, y, z) => {
        let bx = board[x];
        let by = board[y];
        let bz = board[z];
        if (bx == " " && by == who && bz == who) {
            moves.push(x);
        } else if (by == " " && bx == who && bz == who) {
            moves.push(y);
        } else if (bz == " " && bx == who && by == who) {
            moves.push(z);
        }});
    return moves;
}

function getComputerMove() {
    // See if it can win right now.
    let moves = checkTwoInARow(computerXO);

    // If not, see if it needs to block.
    if (moves.length == 0) {
        moves = checkTwoInARow(myXO);
    }

    if (moves.length == 0) {
        moves = goodMoves.get(board.join(""));
    }

    // If not, just pick an empty square.
    if (moves === undefined) {
        moves = [];
        for (let i = 0; i < 9; i++) {
            if (board[i] == " ") {
                moves.push(i);
            }
        }
    }

    // Return one of the moves a random, or null if there is none.
    return moves.length == 0 ? null :
        moves[Math.floor(Math.random() * moves.length)];
}

function clickSquare(id) {
    if (gameOver) {
        return;
    }
    let num = parseInt(id.charAt(id.length - 1));
    if (board[num] != " ") {
        return;
    }
    board[num] = myXO;
    document.getElementById(id).innerHTML =
        myXO == "X" ? xSquare : oSquare;

    if (checkGameOver(myXO)) {
        gameOver = true;
        return;
    }

    m = getComputerMove();
    if (m !== null) {
        board[m] = computerXO;
        document.getElementById(`square${m}`).innerHTML =
            computerXO == "X" ? xSquare : oSquare;
            
        if (checkGameOver(computerXO)) {
            gameOver = true;
            return;
        }
    }
}
</script>
<style>
#board {
  grid-template-columns: 50px 5px 50px 5px 50px;
  grid-template-rows: 50px 5px 50px 5px 50px;
  grid-gap: 0;
  grid-template-areas:
      'c0 b0 c1 b1 c2'
      'bar0 bar0 bar0 bar0 bar0'
      'c3 b2 c4 b3 c5'
      'bar1 bar1 bar1 bar1 bar1'
      'c6 b4 c7 b5 c8';
}
#board div {
  text-align: center;
}

#square0 {
  grid-area: c0
}
#square1 {
  grid-area: c1
}
#square2 {
  grid-area: c2
}
#square3 {
  grid-area: c3
}
#square4 {
  grid-area: c4
}
#square5 {
  grid-area: c5
}
#square6 {
  grid-area: c6
}
#square7 {
  grid-area: c7
}
#square8 {
  grid-area: c8
}
#message {
  text-align: center;
  width: 160px
}

</style>
<body>
  <h1>Tic-Tac-Toe</h1>
  <div id="selector" style="visibility: visible">
  <p>Would you like to go first or second?</p>
  <input type="radio" id="gofirst" name="who" value="first" checked>
  <label>First (X)</label><br>
  <input type="radio" name ="who" value="second">
  <label>Second (O)</label><br>
  <div><button onclick="playButton()">Play</button></div>
  </div>

  <div id="board" style="display:none">
  <div id="square0"></div>
  <div style="grid-area:b0;">
  <svg style="grid-area:b0;" width=5 height="50">
    <rect width=5 height="50" fill="black">
  </svg>
  </div>
  <div id="square1"></div>
  <svg style="grid-area:b1;" width=5 height="50">
    <rect width=5 height="50" fill="black">
  </svg>
  <div id="square2"></div>
  <svg style="grid-area:bar0; "width="160" heght=5>
    <rect width="160" height=5 fill="black">
  </svg>
  <div id="square3"></div>
  <svg style="grid-area:b2; "width=5 height="50">
    <rect width=5 height="50" fill="black">
  </svg>
  <div id="square4"></div>
  <svg style="grid-area:b3;" width=5 height="50">
    <rect width=5 height="50" fill="black">
  </svg>
  <div id="square5"></div>
  <svg style="grid-area:bar1;" width="160" height=5>
    <rect width="160" height=5 fill="black">
  </svg>
  <div id="square6"></div>
  <svg style="grid-area:b4;" width=5 height="50">
    <rect width=5 height="50" fill="black">
  </svg>
  <div id="square7"></div>
  <svg style="grid-area:b5;" width=5 height="50">
    <rect width=5 height="50" fill="black">
  </svg>
  <div id="square8"></div>
<div id="message" style="display: none">
</div>
</body>
</html>
