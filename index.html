<!DOCTYPE html>
<!-- Interactive web page that plays Tic-Tac-Toe.
     The site is this single file, index.html.
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tic Tac Toe</title>
<style>
#board {
  /* Define the layout of the elements that make up the board */
  grid-template-columns: 50px 5px 50px 5px 50px;
  grid-template-rows: 50px 5px 50px 5px 50px;
  grid-gap: 0;
  grid-template-areas:
      'cell0 vbar0 cell1 vbar1 cell2'
      'hbar0 hbar0 hbar0 hbar0 hbar0'
      'cell3 vbar2 cell4 vbar3 cell5'
      'hbar1 hbar1 hbar1 hbar1 hbar1'
      'cell6 vbar4 cell7 vbar5 cell8';
}
#message {
  text-align: center;
  width: 160px
}
</style>
</head>
<body>
<h1>Tic-Tac-Toe</h1>
<div id="selector" style="visibility: visible">
<p>Would you like to go first or second?</p>
<label>First (X)
<input type="radio" name="who" value="first" checked>
</label><br \>
<label>Second (O)
<input type="radio" name ="who" value="second">
</label><br \>
<div><button onclick="playButton()">Play</button></div>
</div>
<div id="board" style="display:none"></div>
<div id="message" style="display: none"></div>
<script>

function squareButton(i) { return `<button onclick="clickSquare(${i})"
style="display:block; background: transparent; border: none !important;
font-size:0; height:50px; width:50px;">
</button>`;
}

const svgHdr =
    `<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">` 

const xSquare = `${svgHdr} 
<path d="M 5 5 L 45 45 M 45 5 L 5 45" style="stroke:blue; stroke-width:4" />
</svg>`

const oSquare = `${svgHdr}
<ellipse cx="25" cy="25", rx="20", ry="20"
style="fill:none; stroke:blue; stroke-width:4" />
</svg>`

const restartHTML = `<button onclick="restartButton()">Play Again</button>`;

// Array representation of the board. Values are "X", "O", and " ".
// It is kept consistent with the cell elements in the DOM.
let board = null;

let gameOver = null;
let working = false;

// Which players are which. The values are "X" or "O".
let myXO = null;
let computerX0 = null;

const prompt = "<p>Click on a square to make a move</p>";

// Creates the pieces that make up the black lines of the board.
function blackRectangle(position, width, height) {
    const el = document.createElement("div");
    el.style =
    `${position}; width:${width}px; height:{$height}px; background-color:black;`
    return el;
}

// Will contain references to the nine cell elements in the board.
let cells = []
{
    // Create the board.
    const board = document.getElementById("board");

    // The order does not matter here, since each element gets
    // a grid-area style that specifies its position in the grid.

    // Create the cells, containers that will hold buttons, Xs or Os.
    for (let i = 0; i < 9; ++i) {
        const el = document.createElement("div");
        el.style =`grid-area:cell${i}`;
        cells.push(el);
        board.appendChild(el);
    }

    // Create the vertical bars that separate the cells on each row.
    for (let i = 0; i < 6; ++i) {
        board.appendChild(blackRectangle(`grid-area:vbar${i}`, "5", "50"));
    }

    // Create the horizonal bars that separate the cells on each row.
    for (let i = 0; i < 2; ++i) {
        board.appendChild(blackRectangle(`grid-area:hbar${i}`, "160", "5"));
    }
}

// Function invoked by the initial dialog. It initializes and starts the game.
function playButton() {
    switch (document.querySelector("input[name=who]:checked").value) {
        case "first":
            myXO = "X";
            computerXO = "O";
            break;
        case "second":
            myXO = "O";
            computerXO = "X";
            break;
    }

    gameOver = false;
    board = Array.from(" ".repeat(9));
    if (myXO == "O") {
        // It does not matter where the first move goes.
        board[Math.floor(Math.random() * 9)] = "X";
    }
    document.getElementById("message").innerHTML = prompt;

    // Turn off the selector and turn on the board and message.
    document.getElementById("selector").style.display = "none";
    document.getElementById("board").style.display = "grid";
    document.getElementById("message").style.display = "block";

    // Initialize the board.
    for (let i = 0; i < cells.length; ++i) {
        cells[i].innerHTML = board[i] == " " ? squareButton(i) : xSquare;
    }

    // Add a warning on reload, since that will restart the game.
    // The value of the string returned does not appear to matter,
    // and there is no way to change the generic warning message.
    window.onbeforeunload = () => "";
}

function restartButton() {
    document.getElementById("selector").style.display = "block";
    document.getElementById("board").style.display = "none";
    document.getElementById("message").style.display = "none";
}

// Rotates a board string 90 degrees counterclockwise.
function rotate(b) {
    return `${b[2]}${b[5]}${b[8]}${b[1]}${b[4]}${b[7]}${b[0]}${b[3]}${b[6]}`;

}
// Returns the mirror image of a board string.
function mirror(b) {
    return `${b[2]}${b[1]}${b[0]}${b[5]}${b[4]}${b[3]}${b[8]}${b[7]}${b[6]}`;
}

// Calls func on the eight symmetric variations on board.
function symmetry(func, board) {
    let b = board;
    rotate3 = () => {
        for (let i = 0; i < 3; ++i) {
            func(b);
            b = rotate(b);
        };
    }
    rotate3();
    func(b);
    b = mirror(b);
    rotate3();
    func(b);
}

// The strategy table.
let goodMoves = new Map();

// Adds the moves dictated by an one of the strategy patterns.
function addGoodMoves(board) {
    let moves = [];
    let boardArr = board.split("");

    for (let i = 0; i < boardArr.length; ++i) {
        if (boardArr[i] == "$") {
            moves.push(i);
            boardArr[i] = " ";
        }
    }
    goodMoves.set(boardArr.join(""), moves);
}               

{
    // Each string represents the nine squares 012345678
    // Each $ represents an acceptable next move.
    // Each good move has eight reflections and rotations.
    // If a board position is not listed, then any move is acceptable.
    const patterns = [
        "X   $    ", "X   $O X ", "X  $$X$ O", "X $   $ O", "X $ $O$  ",
        "X $ X $ O", "X O    X$", "X O$  $ $", "X O$ X  O", "X O$$X   ",
        "X O$$X O ", "X O$$X XO", "X$ $O$ $X", "X$$ OX $$", "X$$ OX$$O",
        "XO    $X$", "XO   O$X$", "XO  $X   ", "XO  $XO $", "XO  $XOX$",
        "XO  O $X ", "XO  OX$X$", "XO $ X  O", "XO $$ $  ", "XO $$X$XO",
        "XO $X $ O", "XO O X  $", "XO O X X$", "XO OOX X$", "XO X$ O  ",
        "XO X$$OX$", "XOO$ $$X$", "XOO$ X XO", "XOO$$X$$ ", "XOOO X X$",
        "XOX   O $", "XOX $    ", "XOX $$OX$", "XOXO  OX$", "XOXO$   $",
        "XOXO$  X$", "XOXX  O$ ", "XXO   $O$", "XXO  $  $", "XXO  X$ O",
        "XXO  X$O ", "OX   X$  ", "OX $$ $ $", "OX $$X$O$", "OX $X$$O$",
        "OX X$$ $ ", "OX$X$O $$", "OXOX$    ", " X OXX$O ", " X$O X  $",
        " X$O X O ", " X$OOX   ", "$ $ X $ $", "$O$$X$$ $", "$X    O  ",
        "$X   XO $", "$X O$    ", "$X OOX$X ", "$X$ $  $ ", "$X$ X $O$",
        "$X$$O$$ $", "$X$OX  O ", "$X$XO $  " ];
    for (let i = 0; i < patterns.length; ++i) {
        symmetry((b) => {
            addGoodMoves(b);
        }, patterns[i]);
    }
}

// Calls func on horizontal, vertical, and diagonal rows.
function checkRows(func) {
    func(0, 1, 2);
    func(3, 4, 5);
    func(6, 7, 8);
    func(0, 3, 6);
    func(1, 4, 7);
    func(2, 5, 8);
    func(0, 4, 8);
    func(2, 4, 6);
}

// Returns true if the game is over.
function checkGameOver(who) {
    let winner = false;
    checkRows((x, y, z) => {
        let bx = board[x];
        let by = board[y];
        let bz = board[z];
        if (bx == by && by == bz && bx != " ") {
            winner = true;
        }});
    if (winner) {
        document.getElementById("message").innerHTML =
                    `<h3>${who} wins ${restartHTML}</h3>`;
        return true;
    }
    for (let i = 0; i < 9; ++i) {
        if (board[i] == " ") {
            return false;
        }
    }
    // The game ended in a draw.
    document.getElementById("message").innerHTML =
                `<h3>Tie game ${restartHTML}</h3>`;
    return true;
}

// If a row contains two whos in a row and a space, returns
// the index of the space. Returns every such index, may be empty.
function checkTwoInARow(who) {
    let moves = []
    checkRows((x, y, z) => {
        let bx = board[x];
        let by = board[y];
        let bz = board[z];
        if (bx == " " && by == who && bz == who) {
            moves.push(x);
        } else if (by == " " && bx == who && bz == who) {
            moves.push(y);
        } else if (bz == " " && bx == who && by == who) {
            moves.push(z);
        }});
    return moves;
}

// Returns all the possible good computer moves from this position.
function getComputerMove() {
    // See if it can win right now.
    let moves = checkTwoInARow(computerXO);

    // If not, see if it needs to block.
    if (moves.length == 0) {
        moves = checkTwoInARow(myXO);
    }

    if (moves.length == 0) {
        moves = goodMoves.get(board.join(""));
    }

    // If not, just pick an empty square.
    if (moves === undefined) {
        moves = [];
        for (let i = 0; i < 9; ++i) {
            if (board[i] == " ") {
                moves.push(i);
            }
        }
    }

    // Return one of the moves a random, or null if there is none.
    return moves.length == 0 ? null :
        moves[Math.floor(Math.random() * moves.length)];
}

// Invoked when the user clicks on a square.
function clickSquare(id) {
    if (working || gameOver) {
        return;
    }
    if (board[id] != " ") {
        return;
    }

    board[id] = myXO;
    cells[id].innerHTML = myXO == "X" ? xSquare : oSquare;

    if (checkGameOver(myXO)) {
        gameOver = true;
        window.onbeforeunload = undefined;
        return;
    }

    m = getComputerMove();
    if (m !== null) {
        // Put up a fake progress bar to separate the player's move
        // from the program's move.
        working = true;
        document.getElementById("message").innerHTML =
`<div style="height:10px; background-color:transparent;"></div>
<div style="background-color:#ddd;">
<div id="progressBar" style="width:0; height:15px; background-color:#5c9ec4;">
</div>
</div>`
         const bar = document.getElementById("progressBar");
         var progress = 0
            const interval = setInterval(() => {
                 progress += 3;
                 if (progress > 100) {
                   clearInterval(interval);
                   displayComputerMove(m);
                   working = false;
                 } else {
                   bar.style.width = `${progress}%`;
                 }
         }, 10);
    }
}

function displayComputerMove(m) {
    board[m] = computerXO;
    cells[m].innerHTML = computerXO == "X" ? xSquare : oSquare;
    working = false;
            
    if (checkGameOver(computerXO)) {
        gameOver = true;
        window.onbeforeunload = undefined;
    } else {
        document.getElementById("message").innerHTML = prompt;
    }
}

</script>
</body>
</html>
